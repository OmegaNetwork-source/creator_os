<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connecting to TikTok - Creator OS</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .callback-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            text-align: center;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #000;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-links">
                <a href="/">Back to Dashboard</a>
            </div>
        </div>
    </nav>

    <main class="container">
        <div class="callback-container">
            <h1>Connecting to TikTok...</h1>
            <div class="spinner"></div>
            <p id="status">Processing authentication...</p>
        </div>
    </main>

    <script>
        // Set backend URL for callback page
        window.CREATOR_OS_BACKEND_URL = 'https://creator-os-h4vg.onrender.com';
        
        // Ensure status element is always visible
        const statusEl = document.getElementById('status');
        if (!statusEl) {
            console.error('Status element not found!');
        }
        
        // Handle script loading errors
        window.addEventListener('error', function(e) {
            console.error('Script error:', e);
            if (statusEl) {
                statusEl.textContent = 'Error loading scripts. Please refresh the page.';
                statusEl.style.color = '#f5576c';
            }
        }, true);
    </script>
    <script src="config.js?v=2" onerror="if(statusEl) statusEl.textContent='Error loading config. Please refresh.';"></script>
    <script src="tiktok-api.js?v=2" onerror="if(statusEl) statusEl.textContent='Error loading TikTok API. Please refresh.';"></script>
    <script>
        (async function() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const error = urlParams.get('error');
                const statusEl = document.getElementById('status');

                if (!statusEl) {
                    console.error('Status element not found');
                    return;
                }

                if (error) {
                    statusEl.textContent = `Error: ${error}`;
                    statusEl.style.color = '#f5576c';
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 3000);
                    return;
                }

                if (code) {
                    try {
                        statusEl.textContent = 'Exchanging authorization code...';
                        console.log('Authorization code received:', code.substring(0, 10) + '...');
                        console.log('Backend URL:', window.CREATOR_OS_BACKEND_URL);
                        
                        // Check if TikTokAPI is available
                        if (typeof TikTokAPI === 'undefined') {
                            throw new Error('TikTok API library not loaded. Please refresh the page.');
                        }
                        
                        const api = new TikTokAPI();
                        
                        // Add timeout for token exchange
                        const tokenPromise = api.exchangeCodeForToken(code);
                        const timeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Request timed out. The backend may be sleeping. Please try again.')), 30000)
                        );
                        
                        const result = await Promise.race([tokenPromise, timeoutPromise]);
                        console.log('Token exchange successful:', result);
                        console.log('Stored access token:', localStorage.getItem('tiktok_access_token') ? 'YES' : 'NO');
                        console.log('Stored refresh token:', localStorage.getItem('tiktok_refresh_token') ? 'YES' : 'NO');
                        
                        // Verify token was stored
                        const storedToken = localStorage.getItem('tiktok_access_token');
                        if (!storedToken) {
                            throw new Error('Token was not stored properly. Check console for details.');
                        }
                        
                        statusEl.textContent = 'Success! Redirecting to dashboard...';
                        statusEl.style.color = '#000';
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 1500);
                    } catch (err) {
                        console.error('Token exchange error details:', err);
                        const errorMessage = err.message || 'Unknown error occurred';
                        statusEl.textContent = `Error: ${errorMessage}`;
                        statusEl.style.color = '#f5576c';
                        
                        // Show more details in console
                        if (err.response) {
                            console.error('Error response:', err.response);
                        }
                        
                        // If it's a network error, suggest checking backend
                        if (err.message.includes('fetch') || err.message.includes('network') || err.message.includes('Failed to fetch')) {
                            statusEl.textContent += ' (Backend may be sleeping. Wait 30 seconds and try again.)';
                        }
                        
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 5000);
                    }
                } else {
                    statusEl.textContent = 'No authorization code received. Redirecting...';
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                }
            } catch (err) {
                console.error('Fatal error in callback:', err);
                const statusEl = document.getElementById('status');
                if (statusEl) {
                    statusEl.textContent = 'An unexpected error occurred. Redirecting...';
                    statusEl.style.color = '#f5576c';
                }
                setTimeout(() => {
                    window.location.href = '/';
                }, 3000);
            }
        })();
    </script>
</body>
</html>
